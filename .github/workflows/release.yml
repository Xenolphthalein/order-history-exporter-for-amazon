name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Run type check
        run: npm run typecheck

      - name: Run tests
        run: npm run test

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: node build.js
        env:
          NODE_ENV: production

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Package Firefox extension (.xpi)
        run: |
          cd dist/firefox
          zip -r ../../order-history-exporter-for-amazon-${{ steps.version.outputs.VERSION }}-firefox.xpi ./*

      - name: Package Firefox extension (.zip)
        run: |
          cd dist/firefox
          zip -r ../../order-history-exporter-for-amazon-${{ steps.version.outputs.VERSION }}-firefox.zip ./*

      - name: Package Chrome extension (.zip)
        run: |
          cd dist/chrome
          zip -r ../../order-history-exporter-for-amazon-${{ steps.version.outputs.VERSION }}-chrome.zip ./*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-dist
          path: dist/
          retention-days: 1

      - name: Upload release packages
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            order-history-exporter-for-amazon-*.xpi
            order-history-exporter-for-amazon-*.zip
          retention-days: 1

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release packages
        uses: actions/download-artifact@v4
        with:
          name: release-packages

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: ${{ steps.prev_tag.outputs.tag && format('{0}..{1}', steps.prev_tag.outputs.tag, github.ref_name) || '--latest' }}
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.VERSION }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.content }}

            ## Downloads

            - **Firefox**: `.xpi` file (or `.zip` for manual installation)
            - **Chrome/Chromium**: `.zip` file (load unpacked in developer mode)
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: false
          files: |
            order-history-exporter-for-amazon-${{ steps.version.outputs.VERSION }}-firefox.xpi
            order-history-exporter-for-amazon-${{ steps.version.outputs.VERSION }}-firefox.zip
            order-history-exporter-for-amazon-${{ steps.version.outputs.VERSION }}-chrome.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish_chrome:
    name: Publish Chrome Web Store
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.ref_name, '-') }}
    steps:
      - name: Download release packages
        uses: actions/download-artifact@v4
        with:
          name: release-packages

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Publish to Chrome Web Store
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_PUBLISHER_ID: ${{ secrets.CHROME_PUBLISHER_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
          CHROME_ZIP_PATH: order-history-exporter-for-amazon-${{ steps.version.outputs.VERSION }}-chrome.zip
        run: |
          set -euo pipefail

          missing=0
          for required in CHROME_EXTENSION_ID CHROME_PUBLISHER_ID CHROME_CLIENT_ID CHROME_CLIENT_SECRET CHROME_REFRESH_TOKEN; do
            if [ -z "${!required:-}" ]; then
              echo "Missing required workflow variable/secret: $required"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

          resource_name="publishers/${CHROME_PUBLISHER_ID}/items/${CHROME_EXTENSION_ID}"

          token_response=$(curl -sS -X POST "https://oauth2.googleapis.com/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${CHROME_CLIENT_ID}" \
            --data-urlencode "client_secret=${CHROME_CLIENT_SECRET}" \
            --data-urlencode "refresh_token=${CHROME_REFRESH_TOKEN}" \
            --data-urlencode "grant_type=refresh_token")

          access_token=$(echo "$token_response" | jq -r '.access_token')
          if [ -z "$access_token" ] || [ "$access_token" = "null" ]; then
            echo "Could not obtain Chrome Web Store access token"
            echo "$token_response"
            exit 1
          fi

          echo "Uploading ${CHROME_ZIP_PATH} to Chrome Web Store..."
          upload_response=$(curl -sS -X POST "https://chromewebstore.googleapis.com/upload/v2/${resource_name}:upload" \
            -H "Authorization: Bearer ${access_token}" \
            -H "x-goog-api-version: 2" \
            -H "Content-Type: application/zip" \
            --data-binary "@${CHROME_ZIP_PATH}")

          if echo "$upload_response" | jq -e '.error? != null' >/dev/null; then
            echo "Chrome upload API returned an error"
            echo "$upload_response"
            exit 1
          fi

          latest_upload_response="$upload_response"
          upload_state=$(echo "$upload_response" | jq -r '.uploadState // .state // empty')
          is_upload_in_progress() {
            case "$1" in
              UPLOAD_STATE_IN_PROGRESS|IN_PROGRESS|PENDING) return 0 ;;
              *) return 1 ;;
            esac
          }
          is_upload_success() {
            case "$1" in
              UPLOAD_STATE_SUCCESS|SUCCEEDED|SUCCESS) return 0 ;;
              *) return 1 ;;
            esac
          }

          if is_upload_in_progress "$upload_state"; then
            for _ in {1..20}; do
              sleep 5
              status_response=$(curl -sS -X GET "https://chromewebstore.googleapis.com/v2/${resource_name}/fetchStatus" \
                -H "Authorization: Bearer ${access_token}" \
                -H "x-goog-api-version: 2")

              if echo "$status_response" | jq -e '.error? != null' >/dev/null; then
                echo "Chrome fetchStatus API returned an error"
                echo "$status_response"
                exit 1
              fi

              latest_upload_response="$status_response"
              upload_state=$(echo "$status_response" | jq -r '.uploadState // .state // empty')
              ! is_upload_in_progress "$upload_state" && break
            done
          fi

          if ! is_upload_success "$upload_state"; then
            echo "Chrome upload failed with state: ${upload_state:-unknown}"
            echo "$latest_upload_response"
            exit 1
          fi

          echo "Publishing Chrome Web Store item..."
          publish_response=$(curl -sS -X POST "https://chromewebstore.googleapis.com/v2/${resource_name}:publish" \
            -H "Authorization: Bearer ${access_token}" \
            -H "x-goog-api-version: 2")

          if echo "$publish_response" | jq -e '.error? != null' >/dev/null; then
            echo "Chrome publish API returned an error"
            echo "$publish_response"
            exit 1
          fi

          publish_status_values=$(echo "$publish_response" | jq -r '[.status[]?, .state // empty] | map(select(. != "")) | .[]')
          if [ -z "$publish_status_values" ]; then
            echo "Unexpected publish response from Chrome Web Store API"
            echo "$publish_response"
            exit 1
          fi

          publish_ok=1
          while IFS= read -r publish_status; do
            case "$publish_status" in
              OK|ITEM_PENDING_REVIEW|PENDING_REVIEW|IN_REVIEW|PUBLISHED)
                echo "Chrome Web Store publish status: $publish_status"
                ;;
              *)
                echo "Chrome Web Store publish returned non-success status: $publish_status"
                publish_ok=0
                ;;
            esac
          done <<< "$publish_status_values"

          if [ "$publish_ok" -ne 1 ]; then
            echo "$publish_response"
            exit 1
          fi

  publish_firefox:
    name: Publish Firefox Add-ons
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.ref_name, '-') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: extension-dist
          path: dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Submit to Firefox Add-ons
        env:
          FIREFOX_ADDON_ID: ${{ secrets.FIREFOX_ADDON_ID }}
          FIREFOX_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
          FIREFOX_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          set -euo pipefail

          missing=0
          for required in FIREFOX_ADDON_ID FIREFOX_API_KEY FIREFOX_API_SECRET; do
            if [ -z "${!required:-}" ]; then
              echo "Missing required secret: $required"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then exit 1; fi

          AMO_BASE="https://addons.mozilla.org/api/v5"

          # Generate an AMO JWT from API key/secret (valid 5 min)
          generate_jwt() {
            node -e "
              const crypto = require('crypto');
              const header = Buffer.from(JSON.stringify({alg:'HS256',typ:'JWT'})).toString('base64url');
              const now = Math.floor(Date.now()/1000);
              const payload = Buffer.from(JSON.stringify({
                iss: process.env.FIREFOX_API_KEY,
                jti: crypto.randomUUID(),
                iat: now,
                exp: now + 300
              })).toString('base64url');
              const sig = crypto.createHmac('sha256', process.env.FIREFOX_API_SECRET)
                .update(header+'.'+payload).digest('base64url');
              console.log(header+'.'+payload+'.'+sig);
            "
          }

          # Package extension for upload
          cd dist/firefox
          zip -r ../../extension.zip ./*
          cd ../..

          # Package source code for AMO review
          git archive --format=zip HEAD -o source-code.zip

          # Step 1: Upload extension zip for validation
          echo "Uploading extension to AMO..."
          upload_response=$(curl -sS -X POST "${AMO_BASE}/addons/upload/" \
            -H "Authorization: JWT $(generate_jwt)" \
            -F "upload=@extension.zip" \
            -F "channel=listed")

          upload_uuid=$(echo "$upload_response" | jq -r '.uuid // empty')
          if [ -z "$upload_uuid" ]; then
            echo "Failed to upload to AMO"
            echo "$upload_response"
            exit 1
          fi
          echo "Upload UUID: ${upload_uuid}"

          # Step 2: Poll for validation to complete
          echo "Waiting for AMO validation..."
          validation_completed="false"
          MAX_VALIDATION_ATTEMPTS=90
          VALIDATION_POLL_SECONDS=10
          for ((i=1; i<=MAX_VALIDATION_ATTEMPTS; i++)); do
            sleep "$VALIDATION_POLL_SECONDS"

            validation_response=$(curl -sS -X GET "${AMO_BASE}/addons/upload/${upload_uuid}/" \
              -H "Authorization: JWT $(generate_jwt)")

            if echo "$validation_response" | jq -e '.detail? != null' >/dev/null; then
              echo "AMO upload status API returned an error"
              echo "$validation_response"
              exit 1
            fi

            processed=$(echo "$validation_response" | jq -r '.processed // empty')
            validated=$(echo "$validation_response" | jq -r '.validated // empty')
            valid=$(echo "$validation_response" | jq -r '.valid // "false"')

            if [ "$processed" = "true" ] || [ "$validated" = "true" ]; then
              validation_completed="true"
              if [ "$valid" = "true" ]; then
                echo "Validation passed"
                break
              else
                echo "AMO validation failed"
                echo "$validation_response" | jq '.validation // .validation_results // .'
                exit 1
              fi
            fi
            echo "  Validation in progress (attempt ${i}/${MAX_VALIDATION_ATTEMPTS}, processed=${processed:-unknown}, validated=${validated:-unknown})..."
          done

          if [ "$validation_completed" != "true" ]; then
            echo "AMO validation did not complete within timeout (${MAX_VALIDATION_ATTEMPTS} attempts, ${VALIDATION_POLL_SECONDS}s interval)"
            echo "$validation_response"
            exit 1
          fi

          # Step 3: Create version with the validated upload and source code
          echo "Creating version ${VERSION} on AMO..."
          version_response=$(curl -sS -X POST "${AMO_BASE}/addons/addon/${FIREFOX_ADDON_ID}/versions/" \
            -H "Authorization: JWT $(generate_jwt)" \
            -F "upload=${upload_uuid}" \
            -F "source=@source-code.zip")

          version_id=$(echo "$version_response" | jq -r '.id // empty')
          if [ -z "$version_id" ] || [ "$version_id" = "null" ]; then
            echo "Failed to create version on AMO"
            echo "$version_response"
            exit 1
          fi

          echo "Version ${VERSION} submitted to AMO (version ID: ${version_id})"
          echo "The version is now pending review by AMO reviewers"
